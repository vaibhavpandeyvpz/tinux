name: Build Tinux ISOs

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.arch == 'amd64' && 'ubuntu-latest' || 'ubuntu-24.04-arm' }}

    strategy:
      matrix:
        kernel: [6.18.2, 5.15.197]
        busybox: [1.37.0]
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          ARCH="${{ matrix.arch }}"
          sudo apt-get update
          sudo apt-get install -y \
            bison \
            build-essential \
            flex \
            libelf-dev \
            libncurses-dev \
            libssl-dev \
            xz-utils \
            grub-common \
            mtools \
            xorriso

          # Install architecture-specific packages
          if [ "$ARCH" = "amd64" ]; then
            sudo apt-get install -y grub-pc-bin
          elif [ "$ARCH" = "arm64" ]; then
            sudo apt-get install -y grub-efi-arm64 grub-efi-arm64-bin
          fi

      - name: Build Tinux (Kernel ${{ matrix.kernel }}, Busybox ${{ matrix.busybox }}, Arch ${{ matrix.arch }})
        env:
          ARCH: ${{ matrix.arch == 'amd64' && 'x86_64' || 'arm64' }}
        run: |
          # Run build.sh non-interactively by piping 'n' responses
          # Set ARCH for kernel and busybox builds (kernel uses x86_64 for amd64, arm64 for arm64)
          export ARCH=${{ matrix.arch == 'amd64' && 'x86_64' || 'arm64' }}
          echo -e "n\nn" | env ARCH="$ARCH" ./build.sh ${{ matrix.kernel }} ${{ matrix.busybox }}

      - name: Create bootable ISO
        run: |
          ARCH="${{ matrix.arch }}"
          ISO_NAME="tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}-${ARCH}.iso"

          mkdir -p iso/boot/grub

          # Determine kernel image path based on architecture
          if [ "$ARCH" = "amd64" ]; then
            # x86_64 builds to arch/x86/boot/bzImage
            if [ -f "build/bzImage" ]; then
              KERNEL_IMAGE="bzImage"
              KERNEL_PATH="build/bzImage"
            elif [ -f "build/kernel/arch/x86/boot/bzImage" ]; then
              KERNEL_IMAGE="bzImage"
              KERNEL_PATH="build/kernel/arch/x86/boot/bzImage"
            else
              echo "Error: Kernel image not found for amd64"
              exit 1
            fi
          elif [ "$ARCH" = "arm64" ]; then
            # arm64 builds to arch/arm64/boot/Image
            if [ -f "build/Image" ]; then
              KERNEL_IMAGE="Image"
              KERNEL_PATH="build/Image"
            elif [ -f "build/kernel/arch/arm64/boot/Image" ]; then
              KERNEL_IMAGE="Image"
              KERNEL_PATH="build/kernel/arch/arm64/boot/Image"
            else
              echo "Error: Kernel image not found for arm64"
              exit 1
            fi
          fi

          cp "${KERNEL_PATH}" iso/boot/${KERNEL_IMAGE}
          cp build/initramfs.cpio.gz iso/boot/

          # Verify files are in place
          echo "Verifying ISO files:"
          ls -lh iso/boot/
          file iso/boot/${KERNEL_IMAGE}
          file iso/boot/initramfs.cpio.gz

          # Create GRUB configuration
          cat > iso/boot/grub/grub.cfg <<EOF
          set timeout=10
          set default=0

          menuentry "Tinux (Kernel ${{ matrix.kernel }}, ${ARCH})" --class os {
            insmod gzio
            insmod part_msdos
            linux /boot/${KERNEL_IMAGE} console=ttyS0 rdinit=/init
            initrd /boot/initramfs.cpio.gz
          }
          EOF

          # Create ISO using grub-mkrescue (supports both UEFI and BIOS)
          grub-mkrescue -o "${ISO_NAME}" iso/

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}-${{ matrix.arch }}
          path: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}-${{ matrix.arch }}.iso
          retention-days: 30
