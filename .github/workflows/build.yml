name: Build Tinux ISOs

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.arch == 'amd64' && 'ubuntu-latest' || 'ubuntu-latest-arm64' }}

    strategy:
      matrix:
        kernel: [6.18.2, 5.15.197]
        busybox: [1.37.0]
        arch: [amd64, arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          ARCH="${{ matrix.arch }}"
          sudo apt-get update
          sudo apt-get install -y \
            bison \
            build-essential \
            flex \
            libelf-dev \
            libncurses-dev \
            libssl-dev \
            xz-utils \
            grub-common \
            mtools \
            xorriso

          # Install architecture-specific packages
          if [ "$ARCH" = "amd64" ]; then
            sudo apt-get install -y grub-pc-bin syslinux isolinux
          elif [ "$ARCH" = "arm64" ]; then
            sudo apt-get install -y grub-efi-arm64 grub-efi-arm64-bin
          fi

      - name: Build Tinux (Kernel ${{ matrix.kernel }}, Busybox ${{ matrix.busybox }}, Arch ${{ matrix.arch }})
        env:
          ARCH: ${{ matrix.arch }}
        run: |
          # Run build.sh non-interactively by piping 'n' responses
          # Set ARCH for kernel and busybox builds
          export ARCH=${{ matrix.arch }}
          echo -e "n\nn" | ARCH=${{ matrix.arch }} ./build.sh ${{ matrix.kernel }} ${{ matrix.busybox }}

      - name: Create bootable ISO
        run: |
          ARCH="${{ matrix.arch }}"
          ISO_NAME="tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}-${ARCH}.iso"

          mkdir -p iso/boot/grub

          # Find kernel image (name varies by architecture)
          if [ -f build/bzImage ]; then
            KERNEL_IMAGE="bzImage"
            cp build/bzImage iso/boot/
          elif [ -f build/Image ]; then
            KERNEL_IMAGE="Image"
            cp build/Image iso/boot/
          elif [ -f build/vmlinuz ]; then
            KERNEL_IMAGE="vmlinuz"
            cp build/vmlinuz iso/boot/
          else
            echo "Error: Kernel image not found in build/"
            ls -la build/
            exit 1
          fi

          cp build/initramfs.cpio.gz iso/boot/

          # Create GRUB configuration
          cat > iso/boot/grub/grub.cfg <<EOF
          set timeout=5
          set default=0

          menuentry "Tinux (Kernel ${{ matrix.kernel }}, ${ARCH})" {
            linux /boot/${KERNEL_IMAGE} console=ttyS0
            initrd /boot/initramfs.cpio.gz
          }
          EOF

          # Create ISO using grub-mkrescue (supports both UEFI and BIOS)
          grub-mkrescue -o "${ISO_NAME}" iso/ || {
            if [ "$ARCH" = "amd64" ]; then
              echo "grub-mkrescue failed, trying alternative method with isolinux"
              # Alternative: use isolinux for BIOS boot (amd64 only)
              mkdir -p iso/isolinux
              
              # Find isolinux.bin in common locations
              ISOLINUX_BIN=""
              for path in /usr/lib/ISOLINUX/isolinux.bin /usr/lib/syslinux/isolinux.bin /usr/share/syslinux/isolinux.bin /usr/lib/ISOLINUX/isolinux-debug.bin; do
                if [ -f "$path" ]; then
                  ISOLINUX_BIN="$path"
                  break
                fi
              done
              
              if [ -z "$ISOLINUX_BIN" ]; then
                echo "Error: isolinux.bin not found"
                exit 1
              fi
              
              cp "$ISOLINUX_BIN" iso/isolinux/isolinux.bin
              
              # Find ldlinux.c32 if available
              for path in /usr/lib/syslinux/modules/bios/ldlinux.c32 /usr/share/syslinux/ldlinux.c32; do
                if [ -f "$path" ]; then
                  cp "$path" iso/isolinux/ 2>/dev/null && break
                fi
              done
              
              cat > iso/isolinux/isolinux.cfg <<EOF
          DEFAULT linux
          LABEL linux
            KERNEL /boot/${KERNEL_IMAGE}
            APPEND initrd=/boot/initramfs.cpio.gz console=ttyS0
          EOF
              xorriso -as mkisofs \
                -b isolinux/isolinux.bin \
                -c isolinux/boot.cat \
                -no-emul-boot \
                -boot-load-size 4 \
                -boot-info-table \
                -o "${ISO_NAME}" \
                iso/
            else
              echo "Error: grub-mkrescue failed for ${ARCH} and no fallback available"
              exit 1
            fi
          }

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}-${{ matrix.arch }}
          path: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}-${{ matrix.arch }}.iso
          retention-days: 30
