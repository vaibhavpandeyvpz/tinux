name: Build Tinux ISOs

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kernel: [6.18.2, 5.15.197]
        busybox: [1.37.0]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bison \
            build-essential \
            flex \
            libelf-dev \
            libncurses-dev \
            libssl-dev \
            libgnutls28-dev \
            xz-utils \
            unzip \
            python3 \
            python3-pip \
            python3-setuptools \
            mtools \
            xorriso \
            dosfstools \
            e2fsprogs \
            bc

      - name: Build U-Boot
        run: |
          UBOOT_VERSION="v2025.10"
          UBOOT_URL="https://github.com/u-boot/u-boot/archive/refs/tags/${UBOOT_VERSION}.zip"
          UBOOT_CACHE="$HOME/.cache/tinux"
          mkdir -p "$UBOOT_CACHE"

          if [ ! -f "$UBOOT_CACHE/u-boot-${UBOOT_VERSION}.zip" ]; then
            wget -O "$UBOOT_CACHE/u-boot-${UBOOT_VERSION}.zip" "$UBOOT_URL"
          fi

          unzip -q "$UBOOT_CACHE/u-boot-${UBOOT_VERSION}.zip"
          cd u-boot-2025.10
          # Use qemu-x86_64_defconfig for x86_64 EFI support
          make qemu-x86_64_defconfig
          make -j$(nproc)
          # List built files to verify output
          echo "U-Boot build output:"
          ls -lh u-boot*.efi u-boot*.bin 2>/dev/null || find . -name "u-boot*.efi" -o -name "u-boot*.bin" | head -10
          cd ..

      - name: Build Tinux (Kernel ${{ matrix.kernel }}, Busybox ${{ matrix.busybox }})
        env:
          ARCH: x86_64
        run: |
          # Run build.sh non-interactively by piping 'n' responses
          export ARCH=x86_64
          echo -e "n\nn" | env ARCH="$ARCH" ./build.sh ${{ matrix.kernel }} ${{ matrix.busybox }}

      - name: Create bootable ISO
        run: |
          ISO_NAME="tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}.iso"

          # x86_64 builds to arch/x86/boot/bzImage
          if [ -f "build/bzImage" ]; then
            KERNEL_IMAGE="bzImage"
            KERNEL_PATH="build/bzImage"
          elif [ -f "build/kernel/arch/x86/boot/bzImage" ]; then
            KERNEL_IMAGE="bzImage"
            KERNEL_PATH="build/kernel/arch/x86/boot/bzImage"
          else
            echo "Error: Kernel image not found"
            exit 1
          fi

          # Create ISO structure
          mkdir -p iso/boot/efi/boot
          mkdir -p iso/boot

          cp "${KERNEL_PATH}" iso/boot/${KERNEL_IMAGE}
          cp build/initramfs.cpio.gz iso/boot/

          # Use U-Boot as EFI application
          # Find the U-Boot EFI binary (name may vary)
          if [ -f "u-boot-2025.10/u-boot-x86-64.efi" ]; then
            cp u-boot-2025.10/u-boot-x86-64.efi iso/boot/efi/boot/bootx64.efi
          elif [ -f "u-boot-2025.10/u-boot.efi" ]; then
            cp u-boot-2025.10/u-boot.efi iso/boot/efi/boot/bootx64.efi
          else
            # Try to find any .efi file
            UBOOT_EFI=$(find u-boot-2025.10 -name "*.efi" | head -1)
            if [ -n "$UBOOT_EFI" ]; then
              cp "$UBOOT_EFI" iso/boot/efi/boot/bootx64.efi
            else
              echo "Error: U-Boot EFI binary not found"
              find u-boot-2025.10 -type f -name "*efi*" -o -name "*EFI*" | head -10
              exit 1
            fi
          fi

          # Create U-Boot script
          cat > iso/boot/boot.scr <<EOF
          setenv bootargs 'console=ttyS0 rdinit=/init'
          load \${devtype} \${devnum}:1 \${kernel_addr_r} /boot/${KERNEL_IMAGE}
          load \${devtype} \${devnum}:1 \${ramdisk_addr_r} /boot/initramfs.cpio.gz
          zboot \${kernel_addr_r} - \${ramdisk_addr_r}
          EOF
          u-boot-2025.10/tools/mkimage -A x86 -T script -C none -n "Boot script" -d iso/boot/boot.scr iso/boot/boot.scr.uimg || \
            echo "Warning: mkimage failed, using plain script"

          # Verify files are in place
          echo "Verifying ISO files:"
          ls -lh iso/boot/
          file iso/boot/${KERNEL_IMAGE}
          file iso/boot/initramfs.cpio.gz

          # Create EFI-bootable ISO
          xorriso -as mkisofs \
            -R -J \
            -o "${ISO_NAME}" \
            -e boot/efi/boot/bootx64.efi \
            -no-emul-boot \
            -iso-level 3 \
            iso/

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}
          path: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}.iso
          retention-days: 30
