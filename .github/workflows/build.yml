name: Build Tinux ISOs

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        kernel: [6.18.2, 5.15.197]
        busybox: [1.37.0]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            bison \
            build-essential \
            flex \
            libelf-dev \
            libncurses-dev \
            libssl-dev \
            xz-utils \
            syslinux \
            syslinux-common \
            isolinux \
            xorriso \
            bc

      - name: Build Tinux (Kernel ${{ matrix.kernel }}, Busybox ${{ matrix.busybox }})
        env:
          ARCH: x86_64
        run: |
          # Run build.sh non-interactively by piping 'n' responses
          export ARCH=x86_64
          echo -e "n\nn" | env ARCH="$ARCH" ./build.sh ${{ matrix.kernel }} ${{ matrix.busybox }}

      - name: Create bootable ISO
        run: |
          ISO_NAME="tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}.iso"

          # x86_64 builds to arch/x86/boot/bzImage
          if [ -f "build/bzImage" ]; then
            KERNEL_IMAGE="bzImage"
            KERNEL_PATH="build/bzImage"
          elif [ -f "build/kernel/arch/x86/boot/bzImage" ]; then
            KERNEL_IMAGE="bzImage"
            KERNEL_PATH="build/kernel/arch/x86/boot/bzImage"
          else
            echo "Error: Kernel image not found"
            exit 1
          fi

          # Create ISO structure
          mkdir -p iso/boot
          mkdir -p iso/isolinux

          # Copy kernel and initramfs
          cp "${KERNEL_PATH}" iso/boot/vmlinuz64
          cp build/initramfs.cpio.gz iso/boot/initrd.img

          # Copy isolinux files (find in common locations)
          ISOLINUX_BIN=""
          for path in /usr/lib/ISOLINUX/isolinux.bin /usr/lib/syslinux/isolinux.bin /usr/share/syslinux/isolinux.bin; do
            if [ -f "$path" ]; then
              ISOLINUX_BIN="$path"
              break
            fi
          done

          if [ -z "$ISOLINUX_BIN" ]; then
            echo "Error: isolinux.bin not found"
            exit 1
          fi

          cp "$ISOLINUX_BIN" iso/isolinux/isolinux.bin

          # Copy required syslinux files (ldlinux.c32 is critical)
          # First, find where syslinux files are located
          echo "Searching for syslinux files..."
          find /usr -name "ldlinux.c32" 2>/dev/null | head -5
          find /usr -name "isolinux.bin" 2>/dev/null | head -5

          SYSLINUX_DIR=""
          for dir in /usr/lib/syslinux /usr/share/syslinux /usr/lib/ISOLINUX /usr/lib/syslinux/modules/bios; do
            if [ -d "$dir" ] && [ -f "$dir/ldlinux.c32" ]; then
              SYSLINUX_DIR="$dir"
              echo "Found syslinux directory: $SYSLINUX_DIR"
              break
            fi
          done

          if [ -z "$SYSLINUX_DIR" ]; then
            # Try to find ldlinux.c32 directly
            LDLINUX_PATH=$(find /usr -name "ldlinux.c32" 2>/dev/null | head -1)
            if [ -n "$LDLINUX_PATH" ]; then
              SYSLINUX_DIR=$(dirname "$LDLINUX_PATH")
              echo "Found syslinux directory via ldlinux.c32: $SYSLINUX_DIR"
            fi
          fi

          if [ -z "$SYSLINUX_DIR" ]; then
            echo "Error: syslinux directory with ldlinux.c32 not found"
            echo "Listing syslinux-related packages:"
            dpkg -L syslinux syslinux-common 2>/dev/null | grep -E "(ldlinux|isolinux)" | head -10
            exit 1
          fi

          # Copy all .c32 files from syslinux directory
          cp "$SYSLINUX_DIR"/*.c32 iso/isolinux/ 2>/dev/null || true

          # Also try copying from modules/bios if it exists
          if [ -d "$SYSLINUX_DIR/../modules/bios" ]; then
            cp "$SYSLINUX_DIR/../modules/bios"/*.c32 iso/isolinux/ 2>/dev/null || true
          fi

          # Verify critical files
          if [ ! -f "iso/isolinux/ldlinux.c32" ]; then
            echo "Error: ldlinux.c32 not found after copy"
            echo "Files in isolinux directory:"
            ls -la iso/isolinux/
            exit 1
          fi

          # Create isolinux configuration
          cat > iso/isolinux/isolinux.cfg <<EOF
          DEFAULT linux
          LABEL linux
            KERNEL /boot/vmlinuz64
            APPEND initrd=/boot/initrd.img console=ttyS0 rdinit=/init
          EOF

          # Verify files are in place
          echo "Verifying ISO files:"
          ls -lh iso/boot/
          ls -lh iso/isolinux/
          file iso/boot/vmlinuz64
          file iso/boot/initrd.img

          # Find isohdpfx.bin for hybrid MBR
          ISOHDPFX=""
          for path in /usr/lib/syslinux/isohdpfx.bin /usr/share/syslinux/isohdpfx.bin; do
            if [ -f "$path" ]; then
              ISOHDPFX="$path"
              break
            fi
          done

          # Create bootable ISO with isolinux
          if [ -n "$ISOHDPFX" ]; then
            xorriso -as mkisofs \
              -l -r -J \
              -V "TINUX" \
              -b isolinux/isolinux.bin \
              -isohybrid-mbr "$ISOHDPFX" \
              -no-emul-boot \
              -boot-load-size 4 \
              -boot-info-table \
              -c isolinux/boot.cat \
              -o "${ISO_NAME}" \
              iso/
          else
            # Fallback without hybrid MBR
            xorriso -as mkisofs \
              -l -r -J \
              -V "TINUX" \
              -b isolinux/isolinux.bin \
              -no-emul-boot \
              -boot-load-size 4 \
              -boot-info-table \
              -c isolinux/boot.cat \
              -o "${ISO_NAME}" \
              iso/
          fi

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v6
        with:
          name: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}
          path: tinux-kernel-${{ matrix.kernel }}-busybox-${{ matrix.busybox }}.iso
          retention-days: 30
